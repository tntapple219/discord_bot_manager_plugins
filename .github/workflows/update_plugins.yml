name: Update Plugins List

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'plugins_list.json' # 避免無窮迴圈
  schedule:
    - cron: '*/5 * * * *' # 每5分鐘檢查一次 (Github Action 最短間隔建議)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Generate plugins_list.json
      env:
        REPO_NAME: ${{ github.repository }}
        BRANCH_NAME: ${{ github.ref_name }}
      run: |
        python -c "
        import os
        import json

        # 設定基礎 URL
        repo = os.environ['REPO_NAME']
        branch = os.environ['BRANCH_NAME']
        base_url = f'https://raw.githubusercontent.com/{repo}/{branch}'

        plugins = []
        
        # 遍歷目錄
        for folder in os.listdir('.'):
            if folder.startswith('.') or not os.path.isdir(folder):
                continue

            info_path = os.path.join(folder, 'info.json')
            main_path = os.path.join(folder, 'main.py')

            # 檢查必要檔案
            if os.path.exists(info_path) and os.path.exists(main_path):
                print(f'Found plugin: {folder}')
                
                try:
                    with open(info_path, 'r', encoding='utf-8') as f:
                        info_data = json.load(f)
                        
                    # --- 這裡新增讀取 version ---
                    plugin_data = {
                        'name': info_data.get('name', folder),
                        'description': info_data.get('description', 'No description provided.'),
                        'version': info_data.get('version', '1.0.0'), # 讀取版本，預設為 1.0.0
                        'folder_url': f'{base_url}/{folder}'
                    }
                    plugins.append(plugin_data)
                except Exception as e:
                    print(f'Error reading {folder}/info.json: {e}')

        # 寫入結果
        with open('plugins_list.json', 'w', encoding='utf-8') as f:
            json.dump(plugins, f, indent=4, ensure_ascii=False)
        
        print(f'Updated plugins_list.json with {len(plugins)} plugins.')
        "

    - name: Commit and Push if changed
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Auto-update plugins_list.json with versions [skip ci]"
        file_pattern: plugins_list.json
