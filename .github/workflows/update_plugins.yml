name: Update Plugins List

on:
  # 當有程式碼推送到 main 分支時觸發 (最即時)
  push:
    branches:
      - main
    paths-ignore:
      - 'plugins_list.json' # 避免自己更新自己造成無窮迴圈
  
  # 設定排程：每分鐘嘗試執行一次 (實際上可能會有延遲)
  schedule:
    - cron: '*/1 * * * *'
  
  # 允許手動在網頁上點擊按鈕觸發
  workflow_dispatch:

permissions:
  contents: write # 給予寫入權限以便更新 plugins_list.json

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Generate plugins_list.json
      env:
        # 自動取得當前倉庫名稱 (例如 User/Repo)
        REPO_NAME: ${{ github.repository }}
        # 自動取得當前分支名稱
        BRANCH_NAME: ${{ github.ref_name }}
      run: |
        python -c "
        import os
        import json

        # 設定倉庫的 Raw URL 前綴
        repo = os.environ['REPO_NAME']
        branch = os.environ['BRANCH_NAME']
        base_url = f'https://raw.githubusercontent.com/{repo}/{branch}'

        plugins = []
        
        # 遍歷當前目錄下的所有資料夾
        for folder in os.listdir('.'):
            # 忽略隱藏資料夾 (.git, .github 等) 和非資料夾
            if folder.startswith('.') or not os.path.isdir(folder):
                continue

            info_path = os.path.join(folder, 'info.json')
            main_path = os.path.join(folder, 'main.py')

            # 核心檢查：必須同時擁有 info.json 和 main.py
            if os.path.exists(info_path) and os.path.exists(main_path):
                print(f'Found plugin: {folder}')
                
                try:
                    # 嘗試讀取 info.json 來獲取詳細資訊
                    with open(info_path, 'r', encoding='utf-8') as f:
                        info_data = json.load(f)
                        
                    # 建立資料結構
                    plugin_data = {
                        'name': info_data.get('name', folder),
                        'description': info_data.get('description', 'No description provided.'),
                        'folder_url': f'{base_url}/{folder}'
                    }
                    plugins.append(plugin_data)
                except Exception as e:
                    print(f'Error reading {folder}/info.json: {e}')

        # 將結果寫入 plugins_list.json
        with open('plugins_list.json', 'w', encoding='utf-8') as f:
            json.dump(plugins, f, indent=4, ensure_ascii=False)
        
        print(f'Updated plugins_list.json with {len(plugins)} plugins.')
        "

    - name: Commit and Push if changed
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "Auto-update plugins_list.json [skip ci]"
        file_pattern: plugins_list.json
